<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             x:Name="SquaresPageInstance"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:resources="clr-namespace:GridGames.ResX"
             x:Class="GridGames.Views.SquaresPage"
             xmlns:localviews="clr-namespace:GridGames.Views"
             xmlns:vm="clr-namespace:GridGames.ViewModels"
             xmlns:skia="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             xmlns:drawable="clr-namespace:GridGames.Views"
             xmlns:windows="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.WindowsSpecific;assembly=Microsoft.Maui.Controls"
             Title="{Binding Title}">

    <ContentPage.BindingContext>
        <vm:SquaresViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <localviews:FirstRunLoadingSquaresToGridOpacity x:Key="FirstRunLoadingSquaresToGridOpacity" />
            <localviews:GameIsLoadingToGridOpacity x:Key="GameIsLoadingToGridOpacity" />
            <localviews:GameIsLoadingToVisibility x:Key="GameIsLoadingToVisibility" />
            <localviews:CollectionViewHeightToRowHeight x:Key="CollectionViewHeightToRowHeight" />
            <localviews:NumberSizeIndexToGridRowHeight x:Key="NumberSizeIndexToGridRowHeight" />
            <localviews:LabelContainerHeightToFontSize x:Key="LabelContainerHeightToFontSize" />
            <localviews:SquareTargetIndexToIsVisible x:Key="SquareTargetIndexToIsVisible" />
            <localviews:SquareTargetIndexToContainerBorderVisibility x:Key="SquareTargetIndexToContainerBorderVisibility" />
            <localviews:SquareTargetIndexToBackgroundColor x:Key="SquareTargetIndexToBackgroundColor" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Shell.TitleView>
        <Grid Padding="0"
              BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <Label Grid.Column="0" Grid.ColumnSpan="2"
                Text="{x:Static resources:AppResources.Squares}"
                SemanticProperties.HeadingLevel="Level1" FontSize="Title"
                TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                HorizontalOptions="Center" VerticalOptions="Center" />
            <Button Grid.Column="1" Text="&#xf013;" x:Name="SquaresSettingsButton"
                Clicked="SquaresGameSettingsButton_Clicked"
                BorderWidth="0"
                windows:VisualElement.AccessKey="S"
                FontFamily="FA" FontSize="Title" HorizontalOptions="End"
                SemanticProperties.Description="{x:Static resources:AppResources.SquaresSettings}" />
        </Grid>
    </Shell.TitleView>

    <ContentPage.Content>

        <Grid x:Name="PageGrid">

            <CollectionView
                x:Name="SquaresCollectionView"
                SemanticProperties.Description="Squares"
                IsVisible="True"
                VerticalScrollBarVisibility="Never"
                SelectionMode="Single"
                ItemsSource="{Binding SquareListCollection}">
                <CollectionView.Opacity>
                    <MultiBinding Mode="OneWay" Converter="{StaticResource FirstRunLoadingSquaresToGridOpacity}">
                        <Binding Source="{x:Reference SquaresPageInstance}" Path="BindingContext.FirstRunSquares" />
                        <Binding Source="{x:Reference SquaresPageInstance}" Path="BindingContext.GameIsLoading" />
                    </MultiBinding>
                </CollectionView.Opacity>

                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="4" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid HeightRequest="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, 
                            Path=Height, Converter={StaticResource CollectionViewHeightToRowHeight}}"
                            BackgroundColor="{DynamicResource GridBackgroundColor}"
                            AutomationProperties.IsInAccessibleTree="True"
                            SemanticProperties.Description="{Binding AccessibleName, Mode=OneWay}"
                            SemanticProperties.Hint="{Binding AccessibleDescription, Mode=OneWay}">
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Tapped="TapGestureRecognizer_Tapped" />
                            </Grid.GestureRecognizers>
                            <Border
                                AutomationProperties.IsInAccessibleTree="False">
                                <Border.BackgroundColor>
                                    <MultiBinding Mode="OneWay"
                                            Converter="{StaticResource SquareTargetIndexToBackgroundColor}" >
                                        <Binding Path="TargetIndex" />
                                        <Binding Source="{x:Reference SquaresPageInstance}"
                                            Path="BindingContext.ShowDarkTheme" />
                                    </MultiBinding>
                                </Border.BackgroundColor>
                                <Grid AutomationProperties.IsInAccessibleTree="False">
                                    <Grid.RowDefinitions>
                                        <RowDefinition 
                                            x:Name="SquareNumberGridRow"
                                            Height="{Binding
                                                Source={x:Reference SquaresPageInstance},
                                                Path=BindingContext.NumberHeight,
                                                Mode=OneWay,
                                                Converter={StaticResource NumberSizeIndexToGridRowHeight},
                                                ConverterParameter=0}" />
                                        <RowDefinition 
                                            Height="{Binding
                                                Source={x:Reference SquaresPageInstance},
                                                Path=BindingContext.NumberHeight,
                                                Mode=OneWay,
                                                Converter={StaticResource NumberSizeIndexToGridRowHeight},
                                                ConverterParameter=1}" />
                                    </Grid.RowDefinitions>

                                    <Image Grid.Row="0" Grid.RowSpan="2"
                                        Source="{Binding PictureImageSource}"
                                        Aspect="Fill"
                                        AutomationProperties.IsInAccessibleTree="False">
                                        <Image.IsVisible>
                                            <MultiBinding Mode="OneWay" Converter="{StaticResource SquareTargetIndexToIsVisible}">
                                                <Binding Path="TargetIndex" />
                                                <Binding Source="{x:Reference SquaresPageInstance}" Path="BindingContext.ShowPicture" />
                                            </MultiBinding>
                                        </Image.IsVisible>
                                    </Image>

                                    <Grid Grid.Row="0" x:Name="LabelPanel"
                                        BackgroundColor="Transparent"
                                        AutomationProperties.IsInAccessibleTree="False"
                                        IsVisible="{Binding
                                            Source={x:Reference SquaresPageInstance},
                                            Path=BindingContext.ShowNumbers}">
                                        <Border HorizontalOptions="Start"
                                            AutomationProperties.IsInAccessibleTree="False"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}"
                                            IsVisible="{Binding TargetIndex, 
                                                Converter={StaticResource SquareTargetIndexToContainerBorderVisibility}}">
                                            <Label Padding="4,0,4,0" Text="{Binding VisualLabel}"
                                                AutomationProperties.IsInAccessibleTree="False"
                                                TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                                HorizontalOptions="Center" VerticalOptions="Center"
                                                HeightRequest="{Binding Source={RelativeSource 
                                                    AncestorType={x:Type Grid}}, Path=Height}">
                                                <Label.FontSize>
                                                    <!-- Don't only bind to the grid height here, as that leaves the FontSize zero when
                                                        ShowNumbers is set true after moving squares when ShowNumbers is false. -->
                                                    <MultiBinding Mode="OneWay" 
                                                        Converter="{StaticResource LabelContainerHeightToFontSize}">
                                                        <Binding Source="{x:Reference SquaresPageInstance}"
                                                            Path="BindingContext.ShowNumbers" />
                                                        <Binding Source="{RelativeSource AncestorType={x:Type Grid}}" 
                                                            Path="Height" />
                                                    </MultiBinding>
                                                </Label.FontSize>
                                            </Label>
                                        </Border>
                                    </Grid>
                                    <StackLayout AutomationProperties.IsInAccessibleTree="False"
                                        Grid.Row="1" BackgroundColor="Transparent" />
                                </Grid>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Grid x:Name="InputBlockingGrid"
                SemanticProperties.Description="Game input blocker" 
                SemanticProperties.Hint="This only exists to prevent mouse and touch input from hanging the app when used with a screen reader."
                BackgroundColor="Transparent">
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Tapped="FallthroughGrid_Tapped" />
                </Grid.GestureRecognizers>
            </Grid>

            <!-- Show a message when the pictures are being loaded into the squares. -->
            <Border
                IsVisible="{Binding GameIsLoading}"
                Stroke="{AppThemeBinding Light=Black, Dark=White}"
                BackgroundColor="{DynamicResource PageBackgroundColor}"
                SemanticProperties.Description="{x:Static resources:AppResources.LoadingPleaseWait}"
                VerticalOptions="CenterAndExpand" HorizontalOptions="CenterAndExpand">
                <Label x:Name="PleaseWaitLabel"
                    Margin="8"
                    Text="{x:Static resources:AppResources.LoadingPleaseWait}"
                    FontSize="Large" />
            </Border>

            <Border Margin="4" Padding="8"
                IsVisible="{Binding FirstRunSquares}"
                Stroke="{AppThemeBinding Light=Black, Dark=White}"
                BackgroundColor="{DynamicResource PageBackgroundColor}"
                SemanticProperties.Description="{x:Static resources:AppResources.SquaresWelcome}"
                VerticalOptions="CenterAndExpand" HorizontalOptions="CenterAndExpand">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Label Grid.Row="0" x:Name="SquaresWelcomeTitleLabel"
                        Text="{x:Static resources:AppResources.SquaresWelcome}"                        
                        FontSize="Large" FontAttributes="Bold" />
                    <ScrollView Grid.Row="1">
                        <Label x:Name="SquaresWelcomeTitleInstructions" FontSize="Medium">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="{x:Static resources:AppResources.WelcomeInstructions}" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </ScrollView>
                    <Button Grid.Row="2" Margin="0"
                            Text="{x:Static resources:AppResources.Close}" 
                            Clicked="SquaresWelcomeOKButton_Clicked"
                            HorizontalOptions="End" />
                </Grid>
            </Border>

        </Grid>
    </ContentPage.Content>
    
</ContentPage>